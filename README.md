ansible-role-teleport
=========

Ansible role to install [Teleport Access Plane](https://goteleport.com/docs/getting-started/) on a Linux server.

Requirements
------------
Each server has its role. Mainly there are 3 roles : auth, proxy, node. Please see [Teleport Architecture Overview](https://goteleport.com/docs/architecture/overview/)

For proxy node, please provide your own SSL certificate and key file. Place it under `/var/lib/teleport/webproxy_cert.pem` and `/var/lib/teleport/webproxy_key.pem`. Otherwise self-signed certificate will be used. Please make sure `openssl` package is installed.

Role Variables
--------------

These variables are based on [this documentation](https://goteleport.com/docs/setup/reference/config/).

Node name that will be registered on auth server. By default it will use the hostname of the server.
    
    teleport_nodename: "{{ ansible_fqdn }}"

Predefined token for node to connect to auth server

    teleport_auth_token: "xxx-changeme-xxx"

The IP or domain of the auth servers

    teleport_auth_servers:
    - 127.0.0.1:3025

Where to store logs

    teleport_log_path: "/var/lib/teleport/teleport.log"

Possible severity values are INFO, WARN and ERROR (default).
    
    teleport_log_level: "ERROR"

Configuration for the storage back-end used for the cluster state and the audit log.
By default teleport uses the `data_dir` directory on a local filesystem

    teleport_storage_type: "dir"

Turns 'auth' role on. true or false
    
    teleport_auth_enabled: false

A cluster name is used as part of a signature in certificates generated by this CA.
We strongly recommend explicitly setting it to something meaningful as it becomes important when configuring trust between multiple clusters.
IMPORTANT: if you change cluster_name, it will invalidate all generated
certificates and keys (may need to wipe out /var/lib/teleport directory)

    teleport_auth_cluster_name: "main"

Second_factor can be off, otp, or u2f

    teleport_auth_second_factor: "off"

This section is used if second_factor is set to 'u2f'
Public address of the Teleport proxy, _including_ the `https://` prefix. If you use a port number other than 443, include it as well. `app_id` must never change in the lifetime of the cluster.

    teleport_u2f_app_id: "https://localhost:3080"

List of allowed addresses of the Teleport proxy checked during authentication attempts. This list is used to prevent malicious websites and proxies from requesting U2F challenges on behalf of the legitimate proxy.

    teleport_u2f_facets:
    - https://localhost:3080
    - https://localhost

Locking mode determines how to apply lock views locally available to a Teleport component; can be strict or best_effort.
See the "Locking mode" section for more details
(https://goteleport.com/docs/access-controls/guides/locking/#locking-mode).

    teleport_locking_mode: "best_effort"

IP and the port to bind to. Other Teleport nodes will be connecting to this port (AKA "Auth API" or "Cluster API") to validate client certificates.

    teleport_auth_listen_address: "0.0.0.0:3025"

Pre-defined tokens for adding new nodes to a cluster. Each token specifies the role a new node will be allowed to assume. The more secure way to add nodes is to use `tctl nodes add --ttl` command to generate auto-expiring tokens.

    teleport_auth_tokens_node: []
    teleport_auth_tokens_proxy: []
    teleport_auth_tokens_auth: []


Optional setting for configuring session recording. Possible values are:
  - "node"  : sessions will be recorded on the node level  (the default)
  - "proxy" : recording on the proxy level, see [Recording Proxy Mode](https://goteleport.com/docs/architecture/proxy/#recording-proxy-mode).
   "off"   : session recording is turned off

```
teleport_session_recording: "node"
```

Determines if SSH sessions to cluster nodes are forcefully terminated after no activity from a client (idle client). Examples: "30m", "1h" or "1h30m"

    teleport_client_idle_timeout: "never"

Set labels to nodes. By default it uses Ansible group name.

    teleport_ssh_labels: '{{ hostvars[inventory_hostname].group_names[0] }}'

Turns 'proxy' role on. true or false

    teleport_proxy_enabled: false

The HTTPS listen address to serve the Web UI and also to authenticate the command line (CLI) users via password+HOTP. Also handles the PostgreSQL proxy if database access is enabled.

    teleport_proxy_web_listen_address: "0.0.0.0:3080"


TLS certificate for the HTTPS connection. Configuring these properly is critical for Teleport security.

    teleport_proxy_https_cert_file: "/var/lib/teleport/webproxy_cert.pem"
    teleport_proxy_https_key_file: "/var/lib/teleport/webproxy_key.pem"

Dependencies
------------
None.

Example Playbook
----------------

Example playbook for node servers.

    - hosts: node
      vars:
        teleport_auth_servers: "auth.example.com:3025"
        teleport_auth_token: "abc-xyz"
      roles:
         - { role: roboticpuppies.teleport}

After you deploy an auth server, you must create your first Teleport user only in auth server. For example you can use this command to create user with username `teleport-admin` with roles `editor,access` and is allowed to log into SSH hosts as any of the principals `root`, `ubuntu` or `ec2-user`

```
tctl users add teleport-admin --roles=editor,access --logins=root,ubuntu,ec2-user
```
You will be provided an URL to set that user's password.

Please see Teleport [getting started guide](https://goteleport.com/docs/getting-started/linux-server/)

License
-------

BSD

Author Information
------------------

This role was created in 2021 by [M. Syaifuddin K.](https://msyaifuddin.my.id)